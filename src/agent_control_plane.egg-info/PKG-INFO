Metadata-Version: 2.4
Name: agent-control-plane
Version: 0.1.0
Summary: Runtime control plane for LLM tool use
Author: OpenAI Agent
License: MIT
Requires-Python: >=3.11
Description-Content-Type: text/markdown
Requires-Dist: fastapi>=0.103.0
Requires-Dist: uvicorn[standard]>=0.23.0
Requires-Dist: sqlmodel>=0.0.14
Requires-Dist: sqlalchemy>=2.0.0
Requires-Dist: psycopg[binary]>=3.1.0
Requires-Dist: alembic>=1.12.0
Requires-Dist: pydantic>=2.4.0
Requires-Dist: httpx>=0.25.0
Requires-Dist: pyyaml>=6.0
Requires-Dist: structlog>=23.1.0
Requires-Dist: bcrypt>=4.0.0
Requires-Dist: orjson>=3.9.0
Requires-Dist: python-multipart>=0.0.6
Requires-Dist: itsdangerous>=2.1.0
Requires-Dist: rich>=13.0.0
Requires-Dist: typer>=0.9.0
Provides-Extra: dev
Requires-Dist: pytest>=7.4.0; extra == "dev"
Requires-Dist: pytest-asyncio>=0.21.0; extra == "dev"
Requires-Dist: httpx>=0.25.0; extra == "dev"
Requires-Dist: black>=23.9.0; extra == "dev"
Requires-Dist: ruff>=0.0.291; extra == "dev"
Requires-Dist: mypy>=1.6.0; extra == "dev"
Requires-Dist: types-PyYAML; extra == "dev"
Requires-Dist: types-requests; extra == "dev"

# Agent Control Plane

Runtime control plane enforcing policy, RBAC, DLP, and tamper-evident audit for LLM tool use.

## Repository structure
- `src/acp_backend`: FastAPI service, policy engine, DLP, audit hashing
- `src/acp_sdk`: Python SDK for agents
- `src/acp_cli`: Typer-based CLI
- `policies/`: YAML policy bundles
- `scripts/`: helpers for seeding and setup
- `examples/`: toy agent walkthrough
- `docs/`: architecture, security, replay, and policy references
- `tests/`: unit + adversarial harness

## Architecture overview
```
Agent SDK -> /v1/tool/execute -> Policy + RBAC + DLP -> (approval?) -> Tool connector -> Trace store -> Audit log (hash chain)
                                               \-> Replay API
```
- **RBAC** via roles and tool permissions.
- **Policy-as-code** via YAML rules (allow/deny/approval_required + constraints).
- **DLP** redacts secrets/PII/custom regex before persistence and before returning.
- **Audit** append-only, hash-chained entries.
- **Replay** exposes deterministic trace retrieval + dry-run policy evaluation.
- **Tools**: HTTP connector + internal tool registry behind a uniform executor.

## Quickstart
1. Install deps: `make install`
2. Seed demo data: `python scripts/seed_data.py`
3. Run API locally: `make run`
4. Exercise toy agent: `python examples/toy_agent.py`
5. Lint/tests: `make lint` and `make test`

## Docker Compose
```
docker compose up --build
```
Brings up Postgres, API (`localhost:8000`), and Adminer (`localhost:8080`).

## Policy examples
See `policies/default.yaml`:
```yaml
- tool: echo
  decision: allow
  role: operator
- tool: sum_numbers
  decision: approval_required
  role: operator
  constraints:
    max_cost: 100
- tool: secret_fetch
  decision: deny
  purpose: exfiltration
```

## Threat model
- **Untrusted LLM output**: all inputs treated as adversarial; DLP scans args/reasoning and responses.
- **Prompt injection / excessive agency**: adversarial tests assert denials/redactions.
- **Data exfiltration**: allowlist domains + deny rules; approvals gate sensitive tools.
- **Tampering**: audit log hash chain detects removal/modification.
- **Replay**: traces contain canonicalized request/response/policy for deterministic inspection.

## How replay works
- Every tool request persists raw + redacted payloads and policy decision.
- `/v1/traces/{trace_id}/replay?dry_run=true` re-evaluates policy without executing the tool.
- Stored trace payloads enable deterministic reproduction.

## Hash chain
- Each `AuditLogEntry` stores `prev_hash` + `current_hash = sha256(prev_hash + canonical_json(entry))`.
- Any mutation breaks the chain, providing tamper evidence.

## OpenTelemetry compatibility
Trace IDs are propagated from SDK to backend; include them in logs and traces for correlation.

## Approvals
- Policies (or tool config) can require `approval_required`.
- Backend returns `status=PENDING` + `approval_id`; approver calls `/v1/approvals/{id}/approve` to receive execution token.
- Agent retries `execute` with `approval_token` to proceed.

## Adversarial harness
- `tests/adversarial` simulates prompt injection, parameter smuggling, and excessive agency against local API.

